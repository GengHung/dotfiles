DOTFILES_ROOT=`pwd`

# get a string escaping / & for later sed substitution
# usage:  var=$(get prompt message here) || exit 1
# note: need the exit as the ERROR only terminates the $() sub-shell
get()
{
  local default prompt data
  default="$1"; shift

  read -p "$* [${default}]: " -r data
  [ -z "${data}" ] && data="${default}"
  printf '%s' "${data}" | sed 's/\\/\\\\/g;s,/,\\/,g;s,&,\\\&,g'
}

# main program
echo "=> This will install the files to: ${HOME}"
echo -ne "\r=> "

config="${HOME}/.dotfilesrc"
name=
email=

if [ -f "${config}" ]; then
    . "${config}"
    echo "=> ${config} exists"
else
    echo "=> dotfilesrc not exists ..."
    echo "=> Enter some data for substitutions"
    echo -ne "\r=> "

    name=$(get "${name}" Enter full name) || exit 1
    email=$(get "${email}" Enter email address) || exit 1

    rm -f "${config}"
    echo '# .dotfilesrc' >> "${config}"
    echo '' >> "${config}"
    echo 'email='"'"${email}"'" >> "${config}"
    echo 'name='"'"${name}"'" >> "${config}"
fi

gitconfig="${HOME}/.gitconfig"

if [ ! -f "${gitconfig}" ]; then
    echo "=> Configuring gitconfig ..."
    echo -ne "\r=> "

    # use sed to substitute som @VAR@ by values saved in ${config}
    sed "s/@NAME@/${name}/g; s/@EMAIL@/${email}/g" git/gitconfig > "${gitconfig}"

    cp git/git-global-ignore ~/.git-global-ignore
    cp git/git-global-attributes ~/.git-global-attributes
else
    echo "=> ${gitconfig} exists"
fi

echo "=> Installing PTMono fonts ..."
cp -fr fonts/PTMono/*ttf ~/Library/Fonts/

echo "=> Installing .zsh-theme ..."
cp -f theme/paulmillr.zsh-theme ~/.oh-my-zsh/themes/

echo "=> Installing .zshrc ..."
cp -f zsh/zshrc ~/.zshrc

# change shell to zsh
if [ $SHELL != '/bin/zsh' ]; then
    echo $SHELL
    chsh -s /bin/zsh
fi

echo "=> Installing .functions ..."
cp -f zsh/functions ~/.functions

# autojump - a faster way to navigate your filesystem
# https://github.com/joelthelion/autojump
echo "=> Installing autojump ..."
echo -ne "\r=> "
brew install autojump

# GNU core utilities
# Use **gls(coreutils)** instead of ls
echo "=> Installing GNU core utilities ..."
echo -ne "\r=> "
brew install coreutils

# Ruby enVironment Manager
if ! type rvm > /dev/null; then
    echo "=> Installing rvm ..."
    echo -ne "\r=> "
    curl -L https://get.rvm.io | bash -s stable --ignore-dotfiles
else
    echo "=> rvm already installed"
fi

# zsh plugin - zsh syntax highlight
if [ ! -d ~/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting ]
then
    echo "=> Installing zsh-syntax-highlighting ..."
    echo -ne "\r=> "
    git clone git://github.com/zsh-users/zsh-syntax-highlighting.git ~/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting
fi

echo "=> Done"